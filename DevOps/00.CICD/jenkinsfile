pipeline {
    agent { label 'local' }

    environment {
        REPO_PATH = '/var/lib/jenkins/Progress-Pulse'
        DOCKER_IMAGE = 'progresspulse/pulse'
        BACKEND_DOCKER_FILE = 'DevOps/01.Build/Production/backend.Dockerfile'
        FRONTEND_DOCKER_FILE = 'DevOps/01.Build/Production/frontend.Dockerfile'
        BUILD_TAG = "build-${env.BUILD_NUMBER}"
        RELEASE_TAG = "release-${env.BUILD_NUMBER}"

        MONGO_URI = credentials('MONGO_URI')
        PORT = credentials('PORT')
        USER_DB = credentials('USER_DB')
        HABIT_DB = credentials('HABIT_DB')
        EXPENSE_DB = credentials('EXPENSE_DB')
        EMAIL_USER = credentials('EMAIL_USER')
        EMAIL_PASS = credentials('EMAIL_PASS')
        JWT_SECRET_KEY = credentials('JWT_SECRET_KEY')
        REFRESH_TOKEN_SECRET_KEY = credentials('REFRESH_TOKEN_SECRET_KEY')
        ACCESS_TOKEN_EXPIRY = credentials('ACCESS_TOKEN_EXPIRY')
        REFRESH_TOKEN_EXPIRY = credentials('REFRESH_TOKEN_EXPIRY')
        NODE_ENV = credentials('NODE_ENV')
    }

    stages {
        stage('Setting Up Progress Pulse System') {
            steps {
                script {
                    // ---------------------------------------------------------------------------------------------------------------------------
                    // Ensure required packages are installed
                    echo "=== Installting Prerequisites ==="
                    sh '''
                    set -e
                    echo "Checking prerequisites..."
                    sudo apt-get update -y
                    for pkg in apt-transport-https ca-certificates curl software-properties-common gnupg lsb-release git; do
                        if ! dpkg -s "$pkg" &>/dev/null; then
                            echo "Installing missing package: $pkg"
                            sudo apt-get install -y "$pkg"
                        fi
                    done
                    ''' 
                    // ---------------------------------------------------------------------------------------------------------------------------
                    // Ensure Docker and Docker Compose are installed
                    echo "=== Installing Docker and Docker Compose ==="
                    sh '''
                    set -e
                    echo "Checking Docker installation..."

                    if ! command -v docker &> /dev/null; then
                        echo "Installing Docker..."
                        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo tee /usr/share/keyrings/docker-archive-keyring.gpg > /dev/null
                        echo \
                          "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] \
                          https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                        sudo apt-get update -y
                        sudo apt-get install -y docker-ce docker-ce-cli containerd.io
                        sudo systemctl enable docker
                        sudo systemctl start docker
                    else
                        echo "Docker already installed."
                    fi

                    echo "Checking Docker Compose..."
                    if ! command -v docker-compose &> /dev/null; then
                        echo "Installing Docker Compose..."
                        DOCKER_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep tag_name | cut -d '"' -f 4)
                        sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
                        sudo chmod +x /usr/local/bin/docker-compose
                    fi
                    docker-compose --version
                    '''
                    // ---------------------------------------------------------------------------------------------------------------------------
                    // Ensure the Progress Pulse repository is cloned or updated
                    echo "=== Update Progress Pulse Repository ==="
                    sh '''
                    set -e
                    if [ ! -d "$REPO_PATH" ]; then
                        echo "Cloning repository..."
                        sudo mkdir -p /var/lib/jenkins
                        cd /var/lib/jenkins
                        sudo git clone https://github.com/er-pritamdas/Progress-Pulse.git
                    else
                        echo "Repository already exists. Pulling latest changes..."
                        cd "$REPO_PATH"
                        sudo git pull
                    fi
                    '''

                    // ---------------------------------------------------------------------------------------------------------------------------
                    // Update Enviornment Variables
                    echo "=== Setting Up Environment Variables ==="
                    sh """
                    sudo bash -c "cat > $REPO_PATH/Server/.env <<EOF
                    PORT=${PORT}
                    MONGO_URI=${MONGO_URI}
                    USER_DB=${USER_DB}
                    HABIT_DB=${HABIT_DB}
                    EXPENSE_DB=${EXPENSE_DB}
                    EMAIL_USER=${EMAIL_USER}
                    EMAIL_PASS=${EMAIL_PASS}
                    JWT_SECRET_KEY=${JWT_SECRET_KEY}
                    REFRESH_TOKEN_SECRET_KEY=${REFRESH_TOKEN_SECRET_KEY}
                    ACCESS_TOKEN_EXPIRY=${ACCESS_TOKEN_EXPIRY}
                    REFRESH_TOKEN_EXPIRY=${REFRESH_TOKEN_EXPIRY}
                    NODE_ENV=${NODE_ENV}
                    EOF"
                    echo ".env file created successfully."
                    """
                }
            }
        }

        // stage('Build Docker Image') {
        //     steps {
        //         script {
        //             sh '''
        //             cd $REPO_PATH/DevOps/01.Build/Production
        //             echo "Building Docker image..."
        //             docker build -t $DOCKER_IMAGE:$BUILD_TAG .
                       docker build -t backend -f $BACKEND_DOCKER_FILE Server/
                       docker build -t frontend -f $FRONTEND_DOCKER_FILE Client/

        //             '''
        //         }
        //     }
        // }

        // stage('Push Build Image to DockerHub') {
        //     steps {
        //         script {
        //             withCredentials([usernamePassword(credentialsId: 'dockerhub-cred', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
        //                 sh '''
        //                 echo "Logging into DockerHub..."
        //                 echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
        //                 docker push $DOCKER_IMAGE:$BUILD_TAG
        //                 docker logout
        //                 '''
        //             }
        //         }
        //     }
        // }

        // stage('Test Image') {
        //     steps {
        //         script {
        //             sh '''
        //             echo "Pulling image for testing..."
        //             docker pull $DOCKER_IMAGE:$BUILD_TAG
        //             echo "Running test container..."
        //             docker run --rm $DOCKER_IMAGE:$BUILD_TAG /bin/sh -c "echo 'Testing container... All good!'"
        //             echo "Tests completed."
        //             '''
        //         }
        //     }
        // }

        // stage('Push Release Image') {
        //     steps {
        //         script {
        //             withCredentials([usernamePassword(credentialsId: 'dockerhub-cred', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
        //                 sh '''
        //                 docker tag $DOCKER_IMAGE:$BUILD_TAG $DOCKER_IMAGE:$RELEASE_TAG
        //                 echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
        //                 docker push $DOCKER_IMAGE:$RELEASE_TAG
        //                 docker logout
        //                 '''
        //             }
        //         }
        //     }
        // }

        // stage('Deploy Release Locally') {
        //     steps {
        //         script {
        //             sh '''
        //             echo "Pulling and running release image..."
        //             docker pull $DOCKER_IMAGE:$RELEASE_TAG
        //             docker stop progress_pulse || true
        //             docker rm progress_pulse || true
        //             docker run -d --name progress_pulse -p 3000:3000 $DOCKER_IMAGE:$RELEASE_TAG
        //             echo "Application deployed and running at http://localhost:3000"
        //             '''
        //         }
        //     }
        // }
    }

    post {
        always {
            echo "Pipeline completed."
            // sh 'docker ps'
        }
    }
}
